![Black Hat Arsenal](https://raw.githubusercontent.com/toolswatch/badges/master/arsenal/usa/2018.svg?sanitize=true)

# Deep Exploit
**Fully automatic penetration test tool using Machine Learning.**  

---
**Deep Exploit** at **[Black Hat USA 2018 Arsenal](https://www.blackhat.com/us-18/arsenal/schedule/index.html#deep-exploit-11908)**.  

## Overview
DeepExploit is **fully automated penetration test tool** linked with **Metasploit**.  

DeepExploit identifies the status of all opened ports on the target server and **executes the exploit at pinpoint using Machine Learning**.  
It's key features are following.  

 * **Efficiently execute exploit**.  
 DeepExploit can **execute exploits at pinpoint** (minimum 1 attempt) using Machine Learning.  
 * **Deep penetration**.  
 If DeepExploit succeeds the exploit to the target server, it further executes the exploit to other internal servers.  
 * **Self-learning**.  
 DeepExploit can learn how to exploitation by itself (uses **Reinforcement Learning**).  
 It is not necessary for humans to prepare learning data.  
 * **Learning time is very fast**.  
 Generally, reinforcement learning takes a lot of time.  
 So, DeepExploit uses **distributed learning by multi agents**.  
 We adopted an advanced machine learning model called **[A3C](https://arxiv.org/pdf/1602.01783.pdf)**.  

### Abilities of "Deep Exploit".  
 Current DeepExploit's version is a **beta**.  
 But, it can fully automatically execute following actions:  

 * Intelligence gathering.  
 * Threat modeling.  
 * Vulnerability analysis.  
 * Exploitation.  
 * Post-Exploitation.  
 * Reporting.  

### Your benefits.
 By using our DeepExploit, you will benefit from the following.  

 For pentester:  
 (a) They can greatly improve the test efficiency.  
 (b) The more pentester uses DeepExploit, DeepExploit learns how to method of exploitation using machine learning. As a result, accuracy of test can be improve.  

 For Information Security Officer:  
 (c) They can quickly identify vulnerabilities of own servers. As a result, prevent that attackers attack to your servers using vulnerabilities, and protect your reputation by avoiding the negative media coverage after breach.  

 Since attack methods to servers are evolving day by day, there is no guarantee that yesterday's security countermeasures are safety today. It is necessary to quickly find vulnerabilities and take countermeasures. Our DeepExploit will contribute greatly to keep your safety.  

| Note |
|:-----|
| If you are interested, please use them in an environment **under your control and at your own risk**. |

### System component.  
![System Component](./img/system_component.png)  

DeepExploit consists of the **machine learning model (A3C)** and **Metasploit**.  
The A3C executes exploit to the target servers via **RPC API**.  

The A3C is developped by Keras and Tensorflow that famous ML framework based on Python. It is used to **self-learn exploit's way** using deep reinforcement learning. The self-learned's result is stored to **learned data that reusable**.  

Metasploit is most famous penetration test tool in the world. It is used to **execute an exploit to the target servers** based on instructions from the A3C.  

#### How to Train?  
![Deep Exploit](./img/overview_deepexploit.png)  

DeepExploit learns how to method of exploitation using advanced machine learning model called A3C.  

The A3C consists of **multiple neural networks**.  
The neural networks takes the information of the training server gathered in Step1 as input and outputs some kinds of **Payload**. And the A3C uses the **output Payload to Exploit to the training server** via Metasploit. In accordance with the result (success / failure) of Exploit, the A3C **updates the weight of the neural network** (parameter related to attack accuracy). By performing the above processing (learning) with a combination of various inputs, an optimum Payload for input information is gradually output.  
In order to shorten the learning time, we execute this processing in **multi threads**.  

Therefore, **learning by using various training servers**, DeepExploit can execute accurate exploit according to various situations.  
So, DeepExploit uses training servers such as metasploitable3, metasploitable2, owaspbwa for learning.  

 * ex) Training servers  
 [metasploitable2](https://sourceforge.net/projects/metasploitable/files/Metasploitable2/)  
 [metasploitable3](https://github.com/rapid7/metasploitable3)  
 [others](https://www.vulnhub.com/)  

---

## Processing flow
![Intelligence mode](./img/flow.png)  

#### Step 1. Intelligence Gathering.  
##### Port scan
DeepExploit gathers targetting server's information such as **OS type**, **Opened port**, **Product name**, **Product version** using [Nmap](https://nmap.org/).  
After executing Nmap, it extracts above information from following Nmap result.  

 * ex) The result of Nmap.  
 ```
 <port protocol="tcp" portid="21"><state state="open" reason="syn-ack" reason_ttl="0"/><service name="ftp" product="vsftpd" version="2.3.4" ostype="Unix" method="probed" conf="10"><cpe>cpe:/a:vsftpd:vsftpd:2.3.4</cpe></service><script id="ftp-anon" output="Anonymous FTP login allowed (FTP code 230)"/><script id="ftp-syst" output="&#xa;  STAT: &#xa;FTP server status:&#xa;     Connected to 192.168.220.150&#xa;     Logged in as ftp&#xa;     TYPE: ASCII&#xa;     No session bandwidth limit&#xa;     Session timeout in seconds is 300&#xa;     Control connection is plain text&#xa;     Data connections will be plain text&#xa;     vsFTPd 2.3.4 - secure, fast, stable&#xa;End of status"><elem key="STAT">&#xa;FTP server status:&#xa;     Connected to 192.168.220.150&#xa;     Logged in as ftp&#xa;     TYPE: ASCII&#xa;     No session bandwidth limit&#xa;     Session timeout in seconds is 300&#xa;     Control connection is plain text&#xa;     Data connections will be plain text&#xa;     vsFTPd 2.3.4 - secure, fast, stable&#xa;End of status</elem>
</script></port>
 <port protocol="tcp" portid="22"><state state="open" reason="syn-ack" reason_ttl="0"/><service name="ssh" product="OpenSSH" version="4.7p1 Debian 8ubuntu1" extrainfo="protocol 2.0" ostype="Linux" method="probed" conf="10"><cpe>cpe:/a:openbsd:openssh:4.7p1</cpe><cpe>cpe:/o:linux:linux_kernel</cpe></service><script id="ssh-hostkey" output="&#xa;  1024 60:0f:cf:e1:c0:5f:6a:74:d6:90:24:fa:c4:d5:6c:cd (DSA)&#xa;  2048 56:56:24:0f:21:1d:de:a7:2b:ae:61:b1:24:3d:e8:f3 (RSA)"><table>
 
 ...snip...
 
 <osmatch name="Linux 2.6.9 - 2.6.33" accuracy="100" line="59153">
 <osclass type="general purpose" vendor="Linux" osfamily="Linux" osgen="2.6.X" accuracy="100"><cpe>cpe:/o:linux:linux_kernel:2.6</cpe> </osclass>
 </osmatch>
 ```

##### Crawling on the Web Port
Next, DeepExploit crawls on the Web Port to find a product that is difficult to detect by port scanning.  
And, DeepExploit can detect several Web products such as CMS and  Language.  

DeepExploit gets other information such as **opened port numbers**, **protocol types**, **product name**, **product version** using regular expression from result of `service` command.  

In above example, DeepExploit gets following information from the target server.  

| Idx | OS    | Port# | product | version |
|:---:|:-----:|:-----:|:-------:|:-------:|
| 1   | Linux | 21    | vsftpd  | 2.3.4   |
| 2   | Linux | 22    | ssh     | 4.7p1   |
| 3   | Linux | 23    | telnet  | -       |
| 4   | Linux | 25    | postfix | -       |
| 5   | Linux | 53    | bind    | 9.4.2   |
| 6   | Linux | 5900  | vnc     | 3.3     |
| 7   | Linux | 6667  | irc     | -       |
| 8   | Linux | 8180  | tomcat  | -       |
| 9   | Linux | 8180  | apache  | 2.2.8   |
| 10  | Linux | 8180  | php     | 5.5.38  |

#### Step 2. Exploitation.  
DeepExploit execute exploit to the testing server **using learned result** in Step2.  
It can execute exploits at **pinpoint** (minimum 1 attempt).  

#### Step 3. Post-Exploitation.  
If DeepExploit succeeds in Exploit of the testing server, it executes **exploit to the internal servers** with the testing server as a springboard.  

#### Step 4. Generate report.  
DeepExploit generates a report that **summarizes vulnerabilities**.  
Report's style is html.  

---

## Installation
 * Installation movie.  
 [![IMAGE ALT TEXT HERE](http://img.youtube.com/vi/Q8HtNxM9zOQ/0.jpg)](http://www.youtube.com/watch?v=Q8HtNxM9zOQ)
 
#### Step.0 Git clone DeepExploit's repository.  
```
root@kali:~# git clone https://github.com/13o-bbr-bbq/machine_learning_security.git
```

#### Step.1 Get python3-pip
```
root@kali:~# apt-get install python3-pip
```

#### Step.2 Install required python packages.
```
root@kali:~# cd machine_learning_security/DeepExploit
root@kali:~/machine_learning_security/DeepExploit# pip3 install -r requirements.txt
```

#### Step.3 Edit `config.ini` of DeepExploit.
You have to be match `server_host` value with IP address of your environment.  

 ```
 [Common]
 server_host : 192.168.220.144
 server_port : 55553
 msgrpc_user : test
 msgrpc_pass : test1234
 ```

#### Step.4 Edit `proxychains.conf`.
You have to be match port number in `proxychains.conf` with the port number of `config.ini`.  

 * proxychains.conf
 ```
 root@kali:~/machine_learning_security/DeepExploit# vim /etc/proxychains.conf
 ...snip...
 
 [ProxyList]
 # add proxy here ...
 # meanwile
 # defaults set to "tor"
 # socks4  127.0.0.1 9050
 socks4  127.0.0.1 1080
 ```

 * config.ini
 ```
 root@kali:~/machine_learning_security/DeepExploit# vim config.ini
 ...snip...
 proxy_host      : 127.0.0.1
 proxy_port      : 1080
 ```

#### Step.5 Initialize Metasploit DB
You initialize metasploit db (postgreSQL) using msfdb command.

```
root@kali:~# msfdb init
```

#### Step.6 Launch Metasploit Framework
You launch Metasploit on the remote server that installed Metasploit Framework such as Kali Linux.
```
root@kali:~# msfconsole
______________________________________________________________________________
|                                                                              |
|                   METASPLOIT CYBER MISSILE COMMAND V4                        |
|______________________________________________________________________________|
     \\                                  /                      /
      \\     .                          /                      /            x
       \\                              /                      /
        \\                            /          +           /
         \\            +             /                      /
          *                        /                      /
                                  /      .               /
   X                             /                      /            X
                                /                     ###
                               /                     # % #
                              /                       ###
                     .       /
    .                       /      .            *           .
                           /
                          *
                 +                       *

                                      ^
####      __     __     __          #######         __     __     __        ####
####    /    \\ /    \\ /    \\      ###########     /    \\ /    \\ /    \\      ####
################################################################################
################################################################################
# WAVE 4 ######## SCORE 31337 ################################## HIGH FFFFFFFF #
################################################################################
                                                          https://metasploit.com


      =[ metasploit v4.16.15-dev                         ]
+ -- --=[ 1699 exploits - 968 auxiliary - 299 post        ]
+ -- --=[ 503 payloads - 40 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

msf >
```

#### Step.7 Launch RPC Server
You launch RPC Server of Metasploit following.

```
msf> load msgrpc ServerHost=192.168.220.144 ServerPort=55553 User=test Pass=test1234
[*] MSGRPC Service: 192.168.220.144:55553
[*] MSGRPC Username: test
[*] MSGRPC Password: test1234
[*] Successfully loaded plugin: msgrpc
```

 |msgrpc options|description|
 |:---|:---|
 |ServerHost|IP address of your server that launched Metasploit.|
 |ServerPort|Any port number of your server that launched Metasploit.|
 |User|Any user name using authentication.|
 |Pass|Any password using authentication.|

Then, you have to be match argument's values with the values of `config.ini`.  

 ```
 [Common]
 server_host : 192.168.220.144
 server_port : 55553
 msgrpc_user : test
 msgrpc_pass : test1234
 ```

## Usage
#### Step.0 Train Deep Exploit
You execute Deep Exploit with training mode.  

```
root@kali:~/machine_learning_security/DeepExploit# python3 -V
Python 3.6.5rc1
root@kali:~/machine_learning_security/DeepExploit# python3 DeepExploit.py -t 192.168.184.132 -m train
```

 |command options|description|
 |:---|:---|
 |-t, --target |IP address of training vulnerable host.|
 |-m, --mode   |Execution mode "train".|

 * ex) The learning with 10 threads.  
 [![IMAGE ALT TEXT HERE](http://img.youtube.com/vi/8ht4y9tboNY/0.jpg)](http://www.youtube.com/watch?v=8ht4y9tboNY)

#### Step.1 Test using trained Deep Exploit
You execute Deep Exploit with testing mode.  

```
root@kali:~/machine_learning_security/DeepExploit# python DeepExploit.py -t 192.168.184.129 -m test
```

 |command options|description|
 |:---|:---|
 |-t, --target |IP address of test target host.|
 |-m, --mode   |Execution mode "test".|

 * Demo) testing with 1 thread.  
 [![IMAGE ALT TEXT HERE](http://img.youtube.com/vi/lbNj2us4mIw/0.jpg)](http://www.youtube.com/watch?v=lbNj2us4mIw)

#### Step.2 Check scan report
Please check scan report using any web browser.  

```
root@kali:~/machine_learning_security/DeepExploit# firefox report/DeepExploit_test_report.html
```

 * Sample report.  
 ![Report](./img/report.png)

---

## Tips
#### 1. How to change "Exploit module's option".
When Deep Exploit exploits, it uses **default value** of Exploit module options.  
If you want to change option values, please input any value to `"user_specify"` in [`exploit_tree.json`](https://raw.githubusercontent.com/13o-bbr-bbq/machine_learning_security/master/DeepExploit/data/exploit_tree.json) as following.  

```

"unix/webapp/joomla_media_upload_exec": {
    "targets": {
        "0": [
            "generic/custom",
            "generic/shell_bind_tcp",
            "generic/shell_reverse_tcp",

...snip...

        "TARGETURI": {
            "type": "string",
            "required": true,
            "advanced": false,
            "evasion": false,
            "desc": "The base path to Joomla",
            "default": "/joomla",
            "user_specify": "/my_original_dir/"
        },
```
Above example is to change value of `TARGETURI` option in exploit module "`exploit/unix/webapp/joomla_media_upload_exec`" to "`/my_original_dir/`" from "`/joomla`".  

---

## Operation check environment
 * Hardware  
   * OS: Kali Linux 2018.2  
   * CPU: Intel(R) Core(TM) i7-6500U 2.50GHz  
   * GPU: None  
   * Memory: 8.0GB  
 * Software  
   * Metasploit Framework 4.16.15-dev  
   * Python 3.6.5rc1  
   * beautifulsoup4==4.6.0  
   * docopt==0.6.2  
   * Jinja2==2.10  
   * Keras==2.1.6  
   * msgpack-python==0.5.6  
   * numpy==1.13.3  
   * pandas==0.23.0  
   * tensorflow==1.8.0  

---

## More information

[MBSD Blog](https://www.mbsd.jp/blog/20180228.html)  
Sorry, now Japanese only.  
English version is coming soon.  

---

## Licence

[Apache License 2.0](https://github.com/13o-bbr-bbq/machine_learning_security/blob/master/DeepExploit/LICENSE)

---

## SNS

 * [Slack](https://deepexploit.slack.com/)

## Developer

Isao Takaesu  
takaesu235@gmail.com  
[https://twitter.com/bbr_bbq](https://twitter.com/bbr_bbq)
