# Deep Exploit
**Fully automatic penetration test tool using Machine Learning.**  

---

## Overview
Deep Exploit is **fully automated penetration tool** linked with Metasploit.  
Deep Exploit has two exploitation modes.  

 * Intelligence mode  
 Deep Exploit identifies the status of all opened ports on the target server and **executes the exploit at pinpoint using Machine Learning**.  
 * Brute force mode  
 Deep Exploit **thoroughly executes exploits using all combinations of "exploit module", "target" and "payload"** corresponding to user's indicated product name and port number.  

Deep Exploit's key features are following.  

 * **Efficiently execute exploit**.  
 Deep Exploit can **execute exploits at pinpoint** (minimum 1 attempt).  
 * **Deep penetration**.  
 If Deep Exploit succeeds the exploit to the target server, it further executes the exploit to other internal servers.  
 * **Operation is very easy**.  
 Your only operation is to input **one command**.  
 It is very easy!!  
 * **Self-learning**.  
 Deep Exploit doesn't need the "learning data".  
 Deep Exploit can learn how to method of exploitation by itself (uses **reinforcement learning**).  
 * **Learning time is very fast**.  
 Deep Exploit uses distributed learning by **multi agents**.  
 So, we adopted an advanced machine learning model called [A3C](https://arxiv.org/pdf/1602.01783.pdf).  

Current Deep Exploit's version is a beta.  
But, it can automatically execute following actions:  

 * Intelligence gathering.  
 * Threat modeling.  
 * Vulnerability analysis.  
 * Exploitation.  
 * Post-Exploitation.  
 * Reporting.  

### System component.  
![System Component](./img/system_component.png)  

## Processing flow
### Intelligence mode
![Intelligence mode](./img/intelligence_mode.png)  

#### Step 1. Port scan the target server.  
Deep Exploit executes the port scanning using Nmap for gathering target server's information.  
After, Deep Exploit executes two Metasploit's command (`hosts` and `services`) via RPC API.  

 * ex) result of `hosts` command.  
 ```
 Hosts
 =====
 
 address          mac                name  os_name  os_flavor  os_sp  purpose  info  comments
 -------          ---                ----  -------  ---------  -----  -------  ----  --------
 192.168.220.145  00:0c:29:16:3a:ce        Linux               2.6.X  server
 ```

Deep Exploit gets OS type from result of `hosts` command.  
In above example, Deep Exploit gets OS type as **Linux**.  

 * ex) result of `services` command.  
 ```
 Services
 ========
 
 host             port  proto  info
 ----             ----  -----  ----
 192.168.220.145  21    tcp    vsftpd 2.3.4
 192.168.220.145  22    tcp    OpenSSH 4.7p1 Debian 8ubuntu1 protocol 2.0
 192.168.220.145  23    tcp    Linux telnetd
 192.168.220.145  25    tcp    Postfix smtpd
 192.168.220.145  53    tcp    ISC BIND 9.4.2
 
 ...snip...
 
 192.168.220.145  5900  tcp    VNC protocol 3.3
 192.168.220.145  6000  tcp    access denied
 192.168.220.145  6667  tcp    UnrealIRCd
 192.168.220.145  8009  tcp    Apache Jserv Protocol v1.3
 192.168.220.145  8180  tcp    Apache Tomcat/Coyote JSP engine 1.1
 
 RHOSTS => 192.168.220.145
 ```

Deep Exploit gets port numbers, protocol types, product name, product version from result of port scanning.  
In above example, Deep Exploit gets port number as **21**, protocol as **tcp**, product as **vsftpd**, version as **2.3.4**.  

#### Step 2. Exploit using Metasploit for training.  
![Deep Exploit](./img/overview_deepexploit.png)  

Deep Exploit learns how to method of exploitation using advanced machine learning model called A3C.  
So, Deep Exploit uses vulnerable servers such as metasploitable2, owaspbwa for learning.  

 * vulnerable servers (one example)  
 [metasploitable2](https://sourceforge.net/projects/metasploitable/files/Metasploitable2/)  
 [metasploitable3](https://github.com/rapid7/metasploitable3)  
 [others](https://www.vulnhub.com/)  

#### Step 3. Exploit using Metasploit for testing.  

#### Step 4. Post exploit.  

#### Step 5. Generate report.  
Deep Exploit generates a report that summarizes vulnerabilities.  
Report's style is html.  

### Brute force mode
![Brute_force_mode](./img/brute_force_mode.png)  

### Usage
### Common
#### Step.0 Initialize Metasploit DB
Firstly, you initialize metasploit db (postgreSQL) using msfdb command.

```
root@kali:~# msfdb init
```

#### Step.1 Launch Metasploit Framework
You launch Metasploit on the remote server that installed Metasploit Framework such as Kali Linux.
```
root@kali:~# msfconsole
______________________________________________________________________________
|                                                                              |
|                   METASPLOIT CYBER MISSILE COMMAND V4                        |
|______________________________________________________________________________|
     \\                                  /                      /
      \\     .                          /                      /            x
       \\                              /                      /
        \\                            /          +           /
         \\            +             /                      /
          *                        /                      /
                                  /      .               /
   X                             /                      /            X
                                /                     ###
                               /                     # % #
                              /                       ###
                     .       /
    .                       /      .            *           .
                           /
                          *
                 +                       *

                                      ^
####      __     __     __          #######         __     __     __        ####
####    /    \\ /    \\ /    \\      ###########     /    \\ /    \\ /    \\      ####
################################################################################
################################################################################
# WAVE 4 ######## SCORE 31337 ################################## HIGH FFFFFFFF #
################################################################################
                                                          https://metasploit.com


      =[ metasploit v4.16.15-dev                         ]
+ -- --=[ 1699 exploits - 968 auxiliary - 299 post        ]
+ -- --=[ 503 payloads - 40 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

msf >
```

#### Step.2 Launch RPC Server
You launch RPC Server of Metasploit following.
```
msf> load msgrpc ServerHost=192.168.220.144 ServerPort=55553 User=test Pass=test1234
[*] MSGRPC Service: 192.168.220.144:55553
[*] MSGRPC Username: test
[*] MSGRPC Password: test1234
[*] Successfully loaded plugin: msgrpc
```

 |msgrpc options|description|
 |:---|:---|
 |ServerHost|IP address of your server that launched Metasploit. Above example is `192.168.220.144`.|
 |ServerPort|Any port number of your server that launched Metasploit. Above example is `55553`.|
 |User|Any user name using authentication (default => msf). Above example is `test`.|
 |Pass|Any password using authentication (default => random string). Above example is `test1234`.|

#### Step.3 Edit config file.
You have to change following value in [`config.ini`](https://github.com/13o-bbr-bbq/machine_learning_security/blob/master/DeepExploit/config.ini)

```
...snip...

[Common]
server_host : 192.168.220.144
server_port : 55553
msgrpc_user : test
msgrpc_pass : test1234

...snip...

[Metasploit]
lhost       : 192.168.220.144
```

 |config|description|
 |:---|:---|
 |server_host|IP address of your server that launched Metasploit. Your setting value `ServerHost` in Step2.|
 |server_port|Any port number of your server that launched Metasploit. Your setting value `ServerPort` in Step2.|
 |msgrpc_user|Metasploit's user name using authentication. Your setting value `User` in Step2.|
 |msgrpc_pass|Metasploit's password using authentication. Your setting value `Pass` in Step2.|
 |lhost|IP address of your server that launched Metasploit. Your setting value `ServerHost` in Step2.|

### Intelligence mode
#### Step.4 Train Deep Exploit
You execute Deep Exploit with training mode on the client machine.

```
local@client:~$ python DeepExploit.py -t 192.168.184.132 -m train
```

 |command options|description|
 |:---|:---|
 |-t, --target |IP address of training vulnerable host such as Metasploitable2.|
 |-m, --mode   |Execution mode "train".|

 * Demo) learning with 10 threads.  
 [![IMAGE ALT TEXT HERE](http://img.youtube.com/vi/BHJB-gWucp4/0.jpg)](http://www.youtube.com/watch?v=BHJB-gWucp4)

#### Step.5 Test using trained Deep Exploit
You execute Deep Exploit with testing mode on the client machine.

```
local@client:~$ python DeepExploit.py -t 192.168.184.129 -m test
```

 |command options|description|
 |:---|:---|
 |-t, --target |IP address of test target host.|
 |-m, --mode   |Execution mode "test".|

 * Demo) testing with 1 thread.  
 [![IMAGE ALT TEXT HERE](http://img.youtube.com/vi/lbNj2us4mIw/0.jpg)](http://www.youtube.com/watch?v=lbNj2us4mIw)

#### Step.6 Check scan report
Please check scan report using any web browser.  

```
local@client:~$ firefox "Deep Exploit root path"/report/DeepExploit_report.html
```

### Brute force mode

## Tips
#### 1. How to change "Exploit module's option".
When Deep Exploit exploits, it uses **default value** of Exploit module options.  
If you want to change option values, please input any value to `"user_specify"` in [`exploit_tree.json`](https://raw.githubusercontent.com/13o-bbr-bbq/machine_learning_security/master/DeepExploit/data/exploit_tree.json) as following.  

```

"unix/webapp/joomla_media_upload_exec": {
    "targets": {
        "0": [
            "generic/custom",
            "generic/shell_bind_tcp",
            "generic/shell_reverse_tcp",

...snip...

        "TARGETURI": {
            "type": "string",
            "required": true,
            "advanced": false,
            "evasion": false,
            "desc": "The base path to Joomla",
            "default": "/joomla",
            "user_specify": "/my_original_dir/"
        },
```
Above example is to change value of `TARGETURI` option in exploit module "`exploit/unix/webapp/joomla_media_upload_exec`" to "`/my_original_dir/`" from "`/joomla`".  

## Operation check environment
 * Kali Linux 2017.3 (Guest OS on VMWare)  
   * Memory: 8.0GB  
   * Metasploit Framework 4.16.15-dev  
 * Windows 10 Home 64-bit (Host OS)  
   * CPU: Intel(R) Core(TM) i7-6500U 2.50GHz  
   * Memory: 16.0GB  
   * Python 3.6.1（Anaconda3）  
   * tensorflow 1.4.0  
   * Keras 2.1.2  
   * msgpack 0.4.8
   * docopt 0.6.2

## More information

[MBSD Blog](https://www.mbsd.jp/blog/20180228.html)  
Sorry, now japanese only.  
English version is coming soon.  

## Licence

[Apache License 2.0](https://github.com/13o-bbr-bbq/machine_learning_security/blob/master/DeepExploit/LICENSE)

## Contact us

[Isao Takaesu](takaesu235@gmail.com)
